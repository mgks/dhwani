(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=e(n);fetch(n.href,s)}})();class I{constructor(t={}){this.sampleRate=t.sampleRate||44100,this.threshold=t.threshold||.1,this.baseFrequencies={Sa:240,re:256,Re:270,ga:288,Ga:300,Ma:320,"Ma#":337.5,Pa:360,dha:384,Dha:400,ni:450,Ni:480},this.swarOrder=["Sa","re","Re","ga","Ga","Ma","Ma#","Pa","dha","Dha","ni","Ni"],this.octaves=[-1,0,1,2],this.swarMap=this._generateSwarMap()}getPitch(t){if(!t||t.length===0)return null;const e=t.length,a=new Float32Array(e);for(let r=0;r<e;r++)for(let c=0;c<e-r;c++){const f=t[c]-t[c+r];a[r]+=f*f}const n=new Float32Array(e);n[0]=1;let s=0;for(let r=1;r<e;r++)s+=a[r],n[r]=a[r]/(1/r*s);let i=-1;for(let r=2;r<e;r++)if(n[r]<this.threshold){for(;r+1<e&&n[r+1]<n[r];)r++;i=r;break}if(i===-1)return null;const d=this._parabolicInterpolation(n,i);return this.sampleRate/d}getNote(t){if(!t||t<=0)return null;let e=null,a=null,n=1/0,s=0;for(const i of this.octaves)for(const d of this.swarOrder){const r=this.swarMap[i][d];if(Math.abs(r-t)>50)continue;const c=this.getCentsDifference(t,r);Math.abs(c)<Math.abs(n)&&(n=c,e=d,a=i,s=r)}return Math.abs(n)>100?null:{swar:e,octave:a,cents:n,frequency:s}}getCentsDifference(t,e){return 1200*Math.log2(t/e)}_generateSwarMap(){const t={};for(const e of this.octaves){t[e]={};for(const a in this.baseFrequencies)t[e][a]=this.baseFrequencies[a]*Math.pow(2,e)}return t}_parabolicInterpolation(t,e){let a;const n=e<1?e:e-1,s=e+1<t.length?e+1:e;if(n===e)a=t[e]<=t[s]?e:s;else if(s===e)a=t[e]<=t[n]?e:n;else{const i=t[n],d=t[e],r=t[s];a=e+(r-i)/(2*(2*d-r-i))}return a}}const m={smoothingBufferSize:5,uiUpdateFps:60,minVocalFreq:70,maxVocalFreq:1e3,dialWidthPx:60};let u=null,p=null,F=null,v=null,M=!1;const h=[];let b=0;const l=document.getElementById("swarContainer"),w=document.getElementById("detailedSwarDisplay"),y=document.getElementById("startButton"),g=["Sa","re","Re","ga","Ga","Ma","Ma#","Pa","dha","Dha","ni","Ni"],L=[...g,...g,...g];function T(){l.innerHTML="",L.forEach((o,t)=>{const e=document.createElement("div");e.className="swarItem",e.dataset.index=t,e.innerHTML=`
            <div class="swarName">${o}</div>
            <div class="swarIndicator"></div>
        `,l.appendChild(e)})}function q(){const o=document.getElementById("themeToggle"),t=document.documentElement,e=localStorage.getItem("dhwani-theme");e&&t.setAttribute("data-theme",e),o.addEventListener("click",()=>{const a=t.getAttribute("data-theme");let n="light";const s=window.matchMedia("(prefers-color-scheme: dark)").matches;a==="dark"||!a&&s?n="light":n="dark",t.setAttribute("data-theme",n),localStorage.setItem("dhwani-theme",n)})}function O(o){if(!o)return null;h.push(o),h.length>m.smoothingBufferSize&&h.shift();const t=[...h].sort((n,s)=>n-s),e=t[Math.floor(t.length/2)],a=h.reduce((n,s)=>n+s,0)/h.length;return Math.abs(a-e)>5?e:a}function P(o){if(!o){l.style.opacity="0.3",w.innerText="--",Array.from(l.children).forEach(E=>E.classList.remove("active","perfect"));return}l.style.opacity="1";const e=12+g.indexOf(o.swar),a=o.cents/100,n=m.dialWidthPx,s=l.parentElement.offsetWidth,i=(e+a)*n,r=s/2-n/2-i;l.style.transform=`translateX(${r.toFixed(1)}px)`;const c=l.children[e],f=l.querySelector(".active");f&&f!==c&&f.classList.remove("active","perfect"),c&&(c.classList.add("active"),Math.abs(o.cents)<10?c.classList.add("perfect"):c.classList.remove("perfect")),w.innerText=`${o.swar} (${o.octave}) | ${o.frequency.toFixed(1)} Hz | ${o.cents>0?"+":""}${o.cents.toFixed(0)} cents`}function x(){if(!M)return;requestAnimationFrame(x);const o=Date.now();if(o-b<1e3/m.uiUpdateFps)return;b=o;const t=new Float32Array(p.fftSize);p.getFloatTimeDomainData(t);let e=v.getPitch(t);e&&(e<m.minVocalFreq||e>m.maxVocalFreq)&&(e=null);const a=O(e),n=v.getNote(a);P(n)}async function S(){try{u&&await u.close(),u=new AudioContext;const o=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}});F=u.createMediaStreamSource(o),p=u.createAnalyser(),p.fftSize=2048;const t=u.createBiquadFilter();t.type="bandpass",t.frequency.value=400,t.Q.value=.5,F.connect(t),t.connect(p),v=new I({sampleRate:u.sampleRate,threshold:.1}),M=!0,y&&(y.style.display="none"),x()}catch(o){console.error("Microphone Error:",o),w.innerText="Error: Microphone access denied.",alert("Please allow microphone access to use the tuner.")}}document.addEventListener("DOMContentLoaded",()=>{T(),q(),y?y.addEventListener("click",S):(document.body.addEventListener("click",()=>{M||S()},{once:!0}),w.innerText="Tap anywhere to start")});window.addEventListener("resize",()=>{});
